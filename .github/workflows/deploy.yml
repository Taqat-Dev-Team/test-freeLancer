name: Deploy Laravel App to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ” Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ§± Step 1 â€“ Install packages if needed
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        if ! command -v php > /dev/null; then
          echo "ğŸ“¦ Installing system packages..."
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y php php-cli php-mbstring php-xml php-bcmath php-curl php-mysql unzip curl git nginx composer php8.3-gd mysql-server
          sudo systemctl enable mysql
          sudo systemctl start mysql
        else
          echo "âœ… Packages already installed."
        fi
        EOF

    - name: ğŸ“¦ Step 2 â€“ Clone or update Laravel project
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        if [ ! -d /var/www/FreeLancer-Backend ]; then
          sudo git clone -b master https://github.com/Taqat-Dev-Team/FreeLancer-Backend /var/www/FreeLancer-Backend
        else
          cd /var/www/FreeLancer-Backend && sudo git pull origin master
        fi
        EOF

    - name: âš™ï¸ Step 3 â€“ Prepare Laravel environment
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
        cd /var/www/FreeLancer-Backend
        sudo chown -R $USER:$USER .

        if [ ! -f .env ]; then
          echo "â›” .env not found. Please upload it manually."
          exit 1
        fi

        if [ ! -d vendor ]; then
          composer install --no-interaction --prefer-dist
        fi

        if ! grep -q "APP_KEY=base64" .env; then
          php artisan key:generate
        fi
        EOF

        
    - name: ğŸŒ Get EC2 Public IP
      id: get_ip
      run: |
        echo "ip=$(ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'curl -s http://checkip.amazonaws.com')" >> $GITHUB_OUTPUT

    - name: ğŸŒ Show Laravel app URL
      run: |
        echo "ğŸ”— App is running at: http://${{ steps.get_ip.outputs.ip }}:8000"

  
    - name: ğŸŒ Show full app URL
      run: |
        echo "ğŸ”— Access your Laravel app at: http://$(ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'curl -s http://checkip.amazonaws.com'):8000"
